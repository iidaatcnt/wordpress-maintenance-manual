# WordPress 保守手順書

このリポジトリは、WordPressサイトの保守作業の手順とツールを管理するためのものです。
誰でも安全かつ確実に作業を遂行できることを目的としています。

## 1. 基本方針

- **安全性第一:** 本番環境への変更は、必ずバックアップを取得してから実施します。
- **情報分離:** サーバー情報やパスワードなどの機密情報は、このリポジトリでは管理しません。別途、安全な方法で管理・共有してください。
- **再現性:** 手順は可能な限り自動化・スクリプト化し、属人性を排除します。
- **記録:** 作業内容は必ず記録し、チームで共有します。

## 2. 事前準備

### 2.1. 機密情報の設定

作業に必要な機密情報（SSH接続情報、DB情報など）は、プロジェクトルートにある `.env` ファイルに記述します。
まず、`.env.template` ファイルをコピーして `.env` ファイルを作成してください。

```bash
cp .env.template .env
```

その後、`.env` ファイルをエディタで開き、各項目を実際の情報に書き換えてください。

**注意:** `.env` ファイルは `.gitignore` によってリポジトリにはコミットされない設定になっています。絶対にリポジトリに含めないでください。

### 2.2. SSH接続設定

SSHクライアントの設定ファイル (`~/.ssh/config`) に、対象サーバーへの接続情報を追記しておくと、コマンド実行が簡略化できます。

**設定例:**
```
Host [SERVER_ALIAS]
  HostName [SERVER_HOSTNAME]
  User [SSH_USER]
  Port [SSH_PORT]
  IdentityFile [PATH_TO_SSH_KEY]
  TCPKeepAlive yes
  IdentitiesOnly yes
```

## 3. 定期保守作業フロー

### 3.1. バックアップの取得と確認

最も重要な作業です。アップデート作業の前に、必ずファイルとデータベースのバックアップを取得します。

1.  **バックアップスクリプトの実行:**
    ```bash
    ./backup.sh [SITE_NAME]
    ```
    `[SITE_NAME]` には、対象サイトの識別名（例: `hm-labo`, `medicalxcare`）を指定します。

2.  **バックアップファイルの確認:**
    スクリプトの実行後、出力されたログを確認し、バックアップが正常に完了したこと、ファイルサイズが異常でないことを確認します。

### 3.2. アップデート作業

バックアップが正常に完了していることを確認してから、アップデート作業に移ります。

1.  **プラグインのアップデート:**
    - WordPressダッシュボードにログインします。
    - 「プラグイン」一覧画面を開き、更新が必要なプラグインを一つずつ慎重にアップデートします。
    - アップデートごとに、サイトの主要な機能（トップページ、主要な固定ページ、投稿、問い合わせフォームなど）が正常に動作するかを確認します。

2.  **テーマのアップデート:**
    - 利用しているテーマにアップデートがあるか確認します。
    - 有料テーマの場合は、提供元のサイトから最新版をダウンロードし、手順に従って更新します。
    - 更新後、サイトの表示が崩れていないか、機能が正常に動作するかを確認します。

3.  **WordPress本体のアップデート:**
    - プラグインとテーマの互換性を確認した上で、WordPress本体をアップデートします。
    - ダッシュボードの指示に従い、アップデートを実行します。
    - 更新後、再度サイト全体の動作確認を入念に行います。

### 3.3. サイトヘルスチェック

- ダッシュボードの「ツール」 > 「サイトヘルス」を確認します。
- 「致命的な問題」がないかを確認し、あれば原因を調査・対処します。
- 「おすすめの改善」項目を確認し、対応可能なものは計画的に実施します。

### 3.4. 最終バックアップ

- 全ての作業が完了したら、最新の状態でもう一度バックアップを取得します。
    ```bash
    ./backup.sh [SITE_NAME]
    ```

### 3.5. 作業報告

- 実施した作業内容（アップデートしたプラグイン、バージョン情報など）、サイトヘルスチェックの結果、その他特記事項をチャットツールなどで報告します。
- スクリーンショットなどを活用し、変更点が分かりやすいように記録を残します。

## 4. 不定期作業

### 4.1. PHP・データベースのバージョンアップ

レンタルサーバーの仕様変更などにより、PHPやデータベースのバージョンアップが必要になる場合があります。
これはサイト全体に大きな影響を及ぼす可能性があるため、以下の手順で慎重に実施します。

1.  **互換性の事前調査:**
    - 利用中のWordPress本体、テーマ、全プラグインが、新しいPHP/DBバージョンに対応しているかを公式サイトなどで十分に調査します。
2.  **ステージング環境でのテスト:**
    - 可能であれば、本番環境と同一のコピー（ステージング環境）を用意し、そこでバージョンアップを試します。
    - サイトの全機能が問題なく動作することを徹底的にテストします。
3.  **本番環境への適用:**
    - メンテナンス期間をユーザーに告知します。
    - 事前に取得したバックアップからいつでも復元できるように準備します。
    - レンタルサーバーのコントロールパネルなどから、バージョンアップを実行します。
    - 実行後、本番環境で入念な動作確認を行います。

### 4.2. 不要なプラグイン・テーマの削除

- 定期的に、停止中で使用していないプラグインやテーマがないかを確認し、不要なものは削除します。
- これにより、セキュリティリスクを低減し、サイトのパフォーマンスを維持します。

## 5. ツール・スクリプト

### `backup.sh`

サイトのファイルとデータベースをバックアップするためのシェルスクリプトです。
（詳細は `backup.sh` ファイルを参照）

### `update.sh`

WP-CLIを利用して、WordPressのアップデートをコマンドラインから実行するためのスクリプトです。
（詳細は `update.sh` ファイルを参照）
